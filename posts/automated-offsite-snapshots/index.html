<!doctype html><html lang=en data-theme><head><title>Derek Rose | Automated Offsite Snapshots</title><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="My various home automation, electronics, coding, and/or 3D printing projects."><link rel=stylesheet href=https://dereksrose.com/css/style.min.525469a8f9d29a3eacecb5821b76bd6e2207bb7cb98b4f50b08f77363db2bad2.css integrity="sha256-UlRpqPnSmj6s7LWCG3a9biIHu3y5i09QsI93Nj2yutI=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://dereksrose.com/css/markupHighlight.min.8735c129318a1c824d066fc2cd1e3911054460819c296ac99007aeb5044b6605.css integrity="sha256-hzXBKTGKHIJNBm/CzR45EQVEYIGcKWrJkAeutQRLZgU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://dereksrose.com/css/mastodonComments.min.cfa59932ab695ec62c00347d4ab1b28d9e42dbf1a507b9f13f6dd63613fdee68.css integrity="sha256-z6WZMqtpXsYsADR9SrGyjZ5C2/GlB7nxP23WNhP97mg=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://dereksrose.com/css/flex.0a98e97a73f7ce3d056c1da4ac3dfafbb5e1640858c71b5ee31543d9e075edc0.css integrity="sha256-CpjpenP3zj0FbB2krD36+7XhZAhYxxte4xVD2eB17cA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://dereksrose.com/css/lightbox.755b9081fac4c7d97cce7b030e7d2abeb1709a4378526f091b5449fa75076c87.css integrity="sha256-dVuQgfrEx9l8znsDDn0qvrFwmkN4Um8JG1RJ+nUHbIc=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://dereksrose.com/css/figure.615059e170e578e014add3ab4f7401ca633f03ec09e4aff1650eda7444793f2c.css integrity="sha256-YVBZ4XDleOAUrdOrT3QBymM/A+wJ5K/xZQ7adER5Pyw=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=https://dereksrose.com/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=https://dereksrose.com/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://dereksrose.com/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://dereksrose.com/favicons/favicon-16x16.png><link rel=canonical href=https://dereksrose.com/posts/automated-offsite-snapshots/><script type=text/javascript src=https://dereksrose.com/js/anatole-header.min.a3fa728a9f57833a31dfb45c48caaf1e4890c8c97f07bd7133fc2359745edb5d.js integrity="sha256-o/pyip9Xgzox37RcSMqvHkiQyMl/B71xM/wjWXRe210=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Automated Offsite Snapshots"><meta name=twitter:description content="Adding Home Assistant to My Synology/Dropbox Backup Routine There was a time when I felt comfortable using GitHub as my main backup solution for Home Assistant."><meta property="og:title" content="Automated Offsite Snapshots"><meta property="og:description" content="Adding Home Assistant to My Synology/Dropbox Backup Routine There was a time when I felt comfortable using GitHub as my main backup solution for Home Assistant."><meta property="og:type" content="article"><meta property="og:url" content="https://dereksrose.com/posts/automated-offsite-snapshots/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-09T18:39:04-08:00"><meta property="article:modified_time" content="2023-02-19T10:14:00-08:00"><meta property="og:site_name" content="Over-Engineering Is Fun"></head><body><div class="sidebar ."><div class=logo-title><div class=title><img src=https://dereksrose.com/profile.png alt="profile picture"><h3 title><a href=/>Over-Engineering Is Fun</a></h3><div class=description><p>My various home automation, electronics, coding, and/or 3D printing projects.</p></div></div></div><ul class=social-links><li><a href=https://github.com/Bishma/ rel=me aria-label=Github><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=https://mas.to/@bishma rel=me aria-label=Mastodon><i class="fab fa-mastodon fa-2x" aria-hidden=true></i></a></li><li><a href=https://www.linkedin.com/in/dereksrose/ rel=me aria-label=LinkedIn><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><div class=by_farbox>&copy; Derek Rose 2023</div></div></div><div class=main><div class="page-top ."><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/ title>Home</a></li><li><a href=/posts/ title>Posts</a></li><li><a href=/tags/ title>Tags</a></li><li><a href=/about/ title>About</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post ."><div class=post-content><div class=post-title><h1>Automated Offsite Snapshots</h1><div class=info><em class="fas fa-calendar-day"></em>
<span class=date>Sat, Feb 9, 2019</span>
<em class="fas fa-stopwatch"></em>
<span class=reading-time>6-minute read</span></div></div><h1 id=adding-home-assistant-to-my-synologydropbox-backup-routine>Adding Home Assistant to My Synology/Dropbox Backup Routine</h1><p>There was a time when I felt comfortable using GitHub as my main backup solution for
<a href=https://www.home-assistant.io target=_blank>Home Assistant</a>. I would backup my secrets.yaml via my workstation backup routine (on the rare times that it changed) and I considered the database to be expendable. As Add-Ons have started becoming commonplace and various components have started moving from yaml to integrations I no longer consider this sufficient.</p><p>This solution utilizes the
<a href=https://github.com/carstenschroeder/hassio-addons/tree/master/remote-backup target=_blank>Remote Backup</a> addon, my home
<a href=https://www.synology.com target=_blank>Synology Diskstation NAS</a> and
<a href=https://www.dropbox.com target=_blank>Dropbox</a> via encrypted
<a href=https://www.synology.com/en-us/dsm/feature/hyper_backup target=_blank>Hyper Backup</a> tasks.</p><h2 id=requirements>Requirements</h2><h3 id=durability>Durability</h3><p>We&rsquo;ve grown fond enough of the system that I consider it worth at least 3-2-1 for its backups. The chances of meaningful loss with this configuration is very low.</p><ul><li>3+ copies<ul><li>Running in HASS</li><li>Snapshots<ul><li>Previous 3 daily snapshots in Home Assistant</li><li>Previous 14 daily snapshots (above included) in NAS</li></ul></li><li>Backed up to Dropbox<ul><li>Encrypted, versioned, and non-public via Hyperbackup</li></ul></li></ul></li><li>2+ Media<ul><li>Micro-SD (in my Pi)</li><li>SATA Hard Drive (in my NAS)</li><li>Dropbox</li></ul></li><li>1 copy offsite<ul><li><em>See also:</em> Dropbox</li></ul></li></ul><p>Obviously my configs are also still in github, further minimizing risk.</p><h3 id=i-want-the-hass-part-to-be-self-contained>I want the HASS part to be self contained</h3><p>If we need to restore from backup, that restore should be everything needed to be up and running again - including the backup routine. To this end I am going to use Hass.io snapshots, the Hass.io remote backup plugin, and vanilla Home Assistant automations.</p><h3 id=database-too>Database Too</h3><p>It&rsquo;s not expendable anymore but also not&mldr; mission critical (yet). I am not doing 3-2-1 here but I am doing a daily offsite backup.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>The Home Assistant device and the Synology Diskstation have network routes and access controls that allow SSH traffic.</li><li>Hypervisor is set up on the Synology Diskstation and configured to use Dropbox.</li><li>There should be a backup folder in the main volume of the Synology with a home assistant subfolder.<ul><li><code>/volume1/Backups/HomeAssistant/</code></li></ul></li></ul><h2 id=set-up>Set up</h2><h3 id=generate-a-key-pair>Generate A Key Pair</h3><p>A public/private keypair is needed for the remote backup addon (it&rsquo;s also just a good idea). This is best done (saved and securely backed up) somewhere other than the synology.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh-keygen -t rsa -b <span class=m>4096</span> -C <span class=s2>&#34;hass_backup&#34;</span>
</span></span></code></pre></div><p>I used my workstation; saving them in a backed up directory and in my password manager.</p><h3 id=synology-user>Synology User</h3><ol><li>From The Users section of the DSM Control Panel select Create<br><img src=/images/automated-offsite-snapshots_1-user-creation.png alt="User creation screen from the Synology DSM"></li><li>Make sure the user is in the admin group. As of the time of this writing only admin users are allowed SSH.<br><img src=/images/automated-offsite-snapshots_2-groups.png alt="Group Management screen from the Synology DSM"></li><li>The user should only be given access to two folders: the one where backups are being sent (<code>volume1/Backups/HomeAssistant</code>) and the <code>homes</code> directory. If the homes directory doesn&rsquo;t exist it will be created in a later step then it can be given read/write access here.<br><img src=/images/automated-offsite-snapshots_3-folder-permissions.png alt="User permissions screen from the Synology DSM"></li><li>Deny all access to applications<br><img src=/images/automated-offsite-snapshots_4-applications.png alt="User application access screen from the Synology DSM"></li></ol><h3 id=synology-sshscp>Synology SSH/SCP</h3><ol><li>If SSH isn&rsquo;t otherwise on it needs to be enabled.<br><img src=/images/automated-offsite-snapshots_5-ssh.png alt="SSH enabling"><ol><li>Make note of the port.</li></ol></li><li>In the advanced tab of the Users section of the control panel, scroll to the bottom and enable home directories.<br><img src=/images/automated-offsite-snapshots_6-home-directory.png alt="Enabling Home Directories"><ol><li>If the user home directories weren&rsquo;t previously enabled remember to give the <code>hass_backup</code> user read/write permissions in the Synology DSM User Control Panel.</li></ol></li><li>Change the home directory in <code>/etc/passwd</code> to be the <code>homes</code> directory that the Synology created when home directories were enabled. SSHing in using the synology user is now possible, but there will be an error about not being able chdir into your home directory. This error won&rsquo;t prevent fixing of the problem.<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim /etc/passwd
</span></span></code></pre></div><ol><li>Change <code>/var/services/homes/hass_backup</code> to <code>/volume1/homes/hass_backup</code></li><li>I suspect this would be unnecessary if I had enabled home directories before enabling SSH or creating the hass_backup user but I was disinclined to go back and unwind everything to find out.</li></ol></li><li><code>chmod 0750 /volume1/homes/hass_backup</code></li><li>At this point it should be possible to ssh into the synology using the hass_backup user&rsquo;s password (without any errors).<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh hass_backup@&lt;synology ip address&gt;:2222
</span></span></code></pre></div></li></ol><h4 id=enable-public-key-authentication>Enable Public Key Authentication</h4><p>While logged into the Synology via SSH:</p><ol><li><code>sudo vim /etc/ssh/sshd_config</code></li><li>Uncomment these 3 lines<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#RSAAuthentication yes</span>
</span></span><span class=line><span class=cl><span class=c1>#PubkeyAuthentication yes</span>
</span></span><span class=line><span class=cl><span class=c1>#AuthorizedKeysFile .ssh/authorized_keys</span>
</span></span></code></pre></div></li><li>Restart the ssh service<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo synoservicectl --reload sshd
</span></span></code></pre></div></li><li><code>mkdir ~/.ssh</code></li><li><code>chmod 0750 ~/.ssh</code></li><li><code>vim ~/.ssh/authorized_keys</code><ol><li>Paste the contents of the public key generate above into a new line of this file.</li></ol></li><li>At this point it should be possible to ssh into the synology without entering a password.<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -i &lt;location of private key&gt; hass_backup@&lt;synology ip address&gt;:2222
</span></span></code></pre></div></li></ol><h3 id=hass46io-remote-backup-plugin>Hass.io remote backup plugin</h3><ol><li>Add the repository and install the add-on
<a href=https://github.com/carstenschroeder/hassio-addons/tree/master/remote-backup target=_blank>per its instructions</a>.</li><li>Configure it with the everything that was just set up.<br><img src=/images/automated-offsite-snapshots_7-remote-backup-config.png alt="Remote Backup Creation Screen"></li></ol><p>At this point it should be able to test that backups are being sent to the Synology via the Developer Tools Service panel. It will take a few minutes to perform the backup after the service call is made.<br><img src=/images/automated-offsite-snapshots_8-service-test.png alt="Service Test Example"></p><h3 id=automation>Automation</h3><p>This automation is taken directly from the remote backup add-on docs. The time was changed and the id was added.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>daily-backup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alias</span><span class=p>:</span><span class=w> </span><span class=l>Daily Backup at 00:30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trigger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>at</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;00:30:00&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>hassio.addon_start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>addon</span><span class=p>:</span><span class=w> </span><span class=l>954f2f4e_remote_backup</span><span class=w>
</span></span></span></code></pre></div><h3 id=hyper-backup>Hyper Backup</h3><p>The hyper backup job is pretty simple. Backup the <code>HomeAssistant</code> folder and the MariaDB application (which at the time of this writing is only used by Home Assistant).</p><ol><li>Create a new &ldquo;data backup task&rdquo; with Dropbox as its destination.<br><img src=/images/automated-offsite-snapshots_9-create-backup-task.png alt="Backup Destination Window"></li><li>A new browser window will open to grant Hyper Backup dropbox permissions. Allow them.</li><li>Select the Dropbox folder to send to (<code>SynoBackups</code>) and what the and what to call within that folder (<code>HomeAssistant</code>).<br><img src=/images/automated-offsite-snapshots_10-dropbox-setup.png alt="Backup Destination Screen"></li><li>Select the Synology folder to back up from the &ldquo;Data Backup&rdquo; screen. <code>Backups > HomeAssistant</code></li><li>Select the MariaDB 10 from the &ldquo;Application Backup&rdquo; screen.</li><li>Set the backup task settings.<br><img src=/images/automated-offsite-snapshots_11-task-settings.png alt="Backup Setting Screen"><ol><li>The password for this backup is stored in my password manager.</li><li>At the end of the wizard you will be prompted to have the backup&rsquo;s encryption key. The backup can be accessed using either the password or the key. If both are kept safe then at lest one should be available when needed.</li><li>I chose a Hyper Backup time sufficiently after my Home Assistant backup automation.</li></ol></li><li>Choose a rotation schedule. I keep a smart rotation with 128 versions.</li><li>At the end of the wizard, after saving the backup&rsquo;s encryption key, there is an option to back up now.<ol><li>This will be the last thing to test.</li><li>Note: Backing up Maria DB will make it briefly unavailable.</li></ol></li></ol><h2 id=clean-up>Clean Up</h2><p>My snapshots are only about 50M, but I still don&rsquo;t have a reason to keep them all. I am going to prune all local backups older than 14 days.</p><ol><li>Create a User Defined Script under Scheduled Tasks<br><img src=/images/automated-offsite-snapshots_12-scheduled-task-creation.png alt="Scheduled Task Creation Screen"></li><li>The task should run as the backup user. Name it descriptively. I set a scheduled task using the administer account but run the task as the hass backup user.<br><img src=/images/automated-offsite-snapshots_13-task-settings.png alt="Task Creation Screen - General Tab"></li><li>In the schedule tab choose daily at an time.</li><li>Under task settings set notification settings for abnormal terminations. The script to run is a linux find command with delete flag<br><img src=/images/automated-offsite-snapshots_14-task-creation-general.png alt="Task Creation Screen - Task Settings Tab"><br></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd ~
</span></span><span class=line><span class=cl>find /volume1/Backups/HomeAssistant/ -type f -mtime +14 -delete
</span></span></code></pre></div><p>That change to the home directory at the beginning of this script bypasses a bug currently in syology with non-admin user scripts. Without that the script will throw a permission error.</p></div><br><div class=post-footer><div class=more-title>Find More:</div><div class=info><span class=separator><a class=tag href=/tags/home-assistant/>home-assistant</a><a class=tag href=/tags/backups/>backups</a><a class=tag href=/tags/automations/>automations</a></span></div><span class=separator>&nbsp; &nbsp;</span>
<span class=separator><a class=link-reverse href="https://dereksrose.com/posts/appdaemon-logging/?ref=footer">« Appdaemon Logging</a></span>
<span class=separator>&nbsp; | &nbsp;</span>
<span class=separator><a class=link-reverse href="https://dereksrose.com/posts/nws-alerts/?ref=footer">NWS Alerts »</a></span></div></div></div></div></div><script type=text/javascript src=https://dereksrose.com/js/jquery.min.decb4e8fdab5cb7b76ec6470b6fb73d30c7ee8e248d7486f49007f3c525b7acb.js integrity="sha256-3stOj9q1y3t27GRwtvtz0wx+6OJI10hvSQB/PFJbess=" crossorigin=anonymous></script>
<script type=text/javascript src=https://dereksrose.com/js/bundle.min.3ebad6bf39b2e7c2f899d3ed9bc97e8c0c1ead7a1b57472e3387321f673b8077.js integrity="sha256-PrrWvzmy58L4mdPtm8l+jAwerXobV0cuM4cyH2c7gHc=" crossorigin=anonymous></script>
<script type=text/javascript src=https://dereksrose.com/js/medium-zoom.min.e1c6918cbaa90022a5612f0bd71c7bf3be6d036614c5729cebfe14f7b91fa4bc.js integrity="sha256-4caRjLqpACKlYS8L1xx7875tA2YUxXKc6/4U97kfpLw=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-153109937-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=https://dereksrose.com/js/lightbox.min.76de40f9671361fabb5e45e99a176e1740b7cf06557da3b0ce60372bcc92962b.js integrity="sha256-dt5A+WcTYfq7XkXpmhduF0C3zwZVfaOwzmA3K8ySlis=" crossorigin=anonymous></script></body></html>